# templates/docker-compose-backend.yml.j2
version: '3'

networks:
  green-city-net:
    driver: bridge
    name: green-city-network

services:
  backcore:
    image: "{{ ecr_account }}.dkr.ecr.{{ aws_region }}.amazonaws.com/greencity-backcore:{{ ecr_tags.image_tag_backcore }}"
    container_name: gc-backcore
    ports:
      - "8080:8080"
    environment:
      - DATASOURCE_URL={{ datasource_url }}
      - DATASOURCE_USERNAME={{ rds_user }}
      - DATASOURCE_PASSWORD={{ rds_password }}
      - GOOGLE_CLIENT_ID={{ google_client_id }}
      - GOOGLE_API_KEY={{ google_api_key }}
      - CLOUD_NAME={{ cloud_name }}
      - API_KEY={{ api_key }}
      - API_SECRET={{ api_secret }}
      - AZURE_CONNECTION_STRING={{ azure_connection_string }}
      - AZURE_CONTAINER_NAME={{ azure_container_name }}
      - MAX_FILE_SIZE={{ max_file_size }}
      - MAX_REQUEST_SIZE={{ max_request_size }}
      - BUCKET_NAME={{ bucket_name }}
      - STATIC_URL={{ static_url }}
      - DEFAULT_PROFILE_PICTURE={{ default_profile_picture }}
      - CHAT_LINK={{ chat_link }}
      - PROFILE={{ profile }}
      - GOOGLE_APPLICATION_CREDENTIALS={{ google_application_credentials }}
      - CLIENT_APP_URL="http://{{ hostvars[groups['frontend'][0]].frontend_ip }}:4200/"
        

    networks:
      - green-city-net
    restart: unless-stopped

  backuser:
    image: "{{ ecr_account }}.dkr.ecr.{{ aws_region }}.amazonaws.com/greencity-backuser:{{ ecr_tags.image_tag_backuser }}"
    container_name: gc-backuser
    ports:
      - "8060:8060"
    environment:
      - DATASOURCE_URL={{ datasource_url }}
      - DATASOURCE_USER={{ rds_user }}
      - DATASOURCE_PASSWORD={{ rds_password }}
      - EMAIL_ADDRESS={{ email_address }}
      - EMAIL_PASSWORD={{ email_password }}
      - GOOGLE_CLIENT_ID={{ google_client_id }}
      - CLIENT_APP_URL="http://{{ hostvars[groups['frontend'][0]].frontend_ip }}:4200/"
    networks:
      - green-city-net
    restart: unless-stopped



 # üîπ Node Exporter ‚Äî –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–∞–º–æ–π –º–∞—à–∏–Ω—ã
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'

      - '--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc)($$|/)'

    restart: unless-stopped
    networks:
      - green-city-net

  # üîπ cAdvisor ‚Äî –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ backend
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    ports:
      - "8081:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker:/var/lib/docker:ro
    restart: unless-stopped
    networks:
      - green-city-net
