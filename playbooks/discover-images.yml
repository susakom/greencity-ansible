---
- name: Получить последние теги из ECR (frontend, backcore, backuser)
  hosts: localhost
  gather_facts: no
  vars:

    # Get secrets from Vault
    aws_creds: >-
      {{
        lookup('hashi_vault',
          'secret=secret/data/ansible/aws ' +
          'token=' + lookup('env', 'VAULT_TOKEN') + ' ' +
          'url=' + lookup('env', 'VAULT_ADDR') + ' ' +
          'engine_version=2'
        )
      }}

    # Unpack required variables
    aws_region: "{{ aws_creds.AWS_REGION }}"
    ecr_account: "{{ aws_creds.ECR_ACCOUNT }}"


    repos:
      frontend: "greencity-frontend"
      backcore: "greencity-backcore"
      backuser: "greencity-backuser"
    output_file: "/tmp/ecr_tags.json"  

  tasks:
    # (list of all images for future sorting )
    - name: Get images from ECR for frontend 
      shell: |
        aws ecr describe-images \
          --region "{{ aws_region }}" \
          --repository-name "{{ repos.frontend }}" \
          --query 'imageDetails[?imageTags != `null`].{Tags: imageTags, Pushed: imagePushedAt}' \
          --output json
      register: ecr_frontend_raw


    - name:  Get images from ECR for  backcore
      shell: |
        aws ecr describe-images \
          --region "{{ aws_region }}" \
          --repository-name "{{ repos.backcore }}" \
          --query 'imageDetails[?imageTags != `null`].{Tags: imageTags, Pushed: imagePushedAt}' \
          --output json
      register: ecr_backcore_raw


    - name:  Get images from ECR for  backuser
      shell: |
        aws ecr describe-images \
          --region "{{ aws_region }}" \
          --repository-name "{{ repos.backuser }}" \
          --query 'imageDetails[?imageTags != `null`].{Tags: imageTags, Pushed: imagePushedAt}' \
          --output json
      register: ecr_backuser_raw


    - name: Extract and sort (frontend)
      set_fact:
        frontend_images: "{{ (ecr_frontend_raw.stdout | from_json) | sort(attribute='Pushed', reverse=true) | list }}"

    - name: Extract and sort (backcore)
      set_fact:
        backcore_images: "{{ (ecr_backcore_raw.stdout | from_json) | sort(attribute='Pushed', reverse=true) | list }}"

    - name: Extract and sort (backuser)
      set_fact:
        backuser_images: "{{ (ecr_backuser_raw.stdout | from_json) | sort(attribute='Pushed', reverse=true) | list }}"

    - name: Find the latest tag by time  frontend
      set_fact:
        image_tag_frontend: "{{ item.Tags.0 }}"
      loop: "{{ frontend_images }}"
      when: "'latest' not in item.Tags"

    - name: Find the latest tag by time backcore
      set_fact:
        image_tag_backcore: "{{ item.Tags.0 }}"
      loop: "{{ backcore_images }}"
      when: "'latest' not in item.Tags"

    - name: Find the latest tag by time для backuser
      set_fact:
        image_tag_backuser: "{{ item.Tags.0 }}"
      loop: "{{ backuser_images }}"
      when: "'latest' not in item.Tags"

    - name:  Save tags to file
      copy:
        content: |
          {
            "image_tag_frontend": "{{ image_tag_frontend }}",
            "image_tag_backcore": "{{ image_tag_backcore }}",
            "image_tag_backuser": "{{ image_tag_backuser }}"
          }
        dest: "{{ output_file }}"
        mode: '0644'
      when: image_tag_frontend is defined and image_tag_backcore is defined and image_tag_backuser is defined

    - name: Print tags (only with -v flag)
      debug:
        msg: |
          Frontend: {{ image_tag_frontend }}
          Backcore: {{ image_tag_backcore }}
          Backuser: {{ image_tag_backuser }}
      when: image_tag_frontend is defined and ansible_verbosity > 0
