---
- name: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ñ‚ÐµÐ³Ð¸ Ð¸Ð· ECR (frontend, backcore, backuser)
  hosts: localhost
  gather_facts: no
  vars:

    # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð¸Ð· Vault
    aws_creds: >-
      {{
        lookup('hashi_vault',
          'secret=secret/data/ansible/aws ' +
          'token=' + lookup('env', 'VAULT_TOKEN') + ' ' +
          'url=' + lookup('env', 'VAULT_ADDR') + ' ' +
          'engine_version=2'
        )
      }}

    # Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ð½ÑƒÐ¶Ð½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
    aws_region: "{{ aws_creds.AWS_REGION }}"
    ecr_account: "{{ aws_creds.ECR_ACCOUNT }}"


    repos:
      frontend: "greencity-frontend"
      backcore: "greencity-backcore"
      backuser: "greencity-backuser"
    output_file: "/tmp/ecr_tags.json"  # Ð“Ð´Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ‚ÐµÐ³Ð¸

  tasks:
    - name: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ frontend
      shell: |
        aws ecr describe-images \
          --region "{{ aws_region }}" \
          --repository-name "{{ repos.frontend }}" \
          --query 'imageDetails[?imageTags != `null`].{Tags: imageTags, Pushed: imagePushedAt}' \
          --output json
      register: ecr_frontend_raw
      no_log: true

    - name: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ backcore
      shell: |
        aws ecr describe-images \
          --region "{{ aws_region }}" \
          --repository-name "{{ repos.backcore }}" \
          --query 'imageDetails[?imageTags != `null`].{Tags: imageTags, Pushed: imagePushedAt}' \
          --output json
      register: ecr_backcore_raw
      no_log: true

    - name: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ backuser
      shell: |
        aws ecr describe-images \
          --region "{{ aws_region }}" \
          --repository-name "{{ repos.backuser }}" \
          --query 'imageDetails[?imageTags != `null`].{Tags: imageTags, Pushed: imagePushedAt}' \
          --output json
      register: ecr_backuser_raw
      no_log: true

    - name: ðŸ·ï¸Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð¸ Ð¾Ñ‚ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ (frontend)
      set_fact:
        frontend_images: "{{ (ecr_frontend_raw.stdout | from_json) | sort(attribute='Pushed', reverse=true) | list }}"

    - name: Ð˜Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð¸ Ð¾Ñ‚ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ (backcore)
      set_fact:
        backcore_images: "{{ (ecr_backcore_raw.stdout | from_json) | sort(attribute='Pushed', reverse=true) | list }}"

    - name: Ð˜Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð¸ Ð¾Ñ‚ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ (backuser)
      set_fact:
        backuser_images: "{{ (ecr_backuser_raw.stdout | from_json) | sort(attribute='Pushed', reverse=true) | list }}"

    - name: ÐÐ°Ð¹Ñ‚Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ñ‚ÐµÐ³ (Ð½Ðµ latest) Ð´Ð»Ñ frontend
      set_fact:
        image_tag_frontend: "{{ item.Tags.0 }}"
      loop: "{{ frontend_images }}"
      when: "'latest' not in item.Tags"

    - name: ÐÐ°Ð¹Ñ‚Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ñ‚ÐµÐ³ (Ð½Ðµ latest) Ð´Ð»Ñ backcore
      set_fact:
        image_tag_backcore: "{{ item.Tags.0 }}"
      loop: "{{ backcore_images }}"
      when: "'latest' not in item.Tags"

    - name: ÐÐ°Ð¹Ñ‚Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ñ‚ÐµÐ³ (Ð½Ðµ latest) Ð´Ð»Ñ backuser
      set_fact:
        image_tag_backuser: "{{ item.Tags.0 }}"
      loop: "{{ backuser_images }}"
      when: "'latest' not in item.Tags"

    - name:  Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ‚ÐµÐ³Ð¸ Ð² Ñ„Ð°Ð¹Ð»
      copy:
        content: |
          {
            "image_tag_frontend": "{{ image_tag_frontend }}",
            "image_tag_backcore": "{{ image_tag_backcore }}",
            "image_tag_backuser": "{{ image_tag_backuser }}"
          }
        dest: "{{ output_file }}"
        mode: '0644'
      when: image_tag_frontend is defined and image_tag_backcore is defined and image_tag_backuser is defined

    - name: Ð’Ñ‹Ð²ÐµÑÑ‚Ð¸ Ñ‚ÐµÐ³Ð¸ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ -v)
      debug:
        msg: |
          Frontend: {{ image_tag_frontend }}
          Backcore: {{ image_tag_backcore }}
          Backuser: {{ image_tag_backuser }}
      when: image_tag_frontend is defined and ansible_verbosity > 0
